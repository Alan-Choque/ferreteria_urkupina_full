services:
  # mssql service commented out - using Windows host SQL Server instead
  # mssql:
  #   image: mcr.microsoft.com/mssql/server:2022-latest
  #   environment:
  #     ACCEPT_EULA: "Y"
  #     MSSQL_SA_PASSWORD: "YourStrong!Passw0rd"
  #     MSSQL_PID: "Express"
  #   ports:
  #     - "1433:1433"
  #   volumes:
  #     - mssql_data:/var/opt/mssql

  api:
    build: .
    environment:
      # Variables de entorno (DATABASE_URL debe estar en .env, no aquí)
      PYTHONPATH: "/app"
      # JWT_SECRET puede venir de .env o usar default
      JWT_SECRET: "${JWT_SECRET:-change-me}"
    ports:
      # Puerto mapeado: host:contenedor
      - "8000:8000"
      # Opcional: segunda variante en puerto 8080 (comentada)
      # - "8080:8000"
    env_file:
      - .env
    volumes:
      - ./app:/app/app
      - ./scripts:/app/scripts
      - ./alembic:/app/alembic
    # ¡NO montes .env dentro del contenedor! Evita: - ./.env:/app/.env
    # Para evitar conflictos con pydantic-settings leyendo /app/.env
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8000/api/v1/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s
